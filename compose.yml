# Podman Compose configuration for hands-off laemp.sh testing
# Works with both podman-compose and docker compose
#
# Services:
#   - moodle-test-ubuntu: Ubuntu 24.04 LTS test environment (port 9443)
#   - moodle-test-debian: Debian 13 (Trixie) test environment (port 8443)
#
# Hands-Off Usage:
#   podman-compose up --build               # Build and start both, runs laemp.sh automatically
#   podman-compose logs -f moodle-test-ubuntu  # Follow Ubuntu installation logs
#   podman-compose logs -f moodle-test-debian  # Follow Debian installation logs
#
# After installation completes (~5-10 minutes), access Moodle at:
#   https://moodle.romn.co:9443  # Ubuntu container
#   https://moodle.romn.co:8443  # Debian container
#   (Requires "moodle.romn.co" â†’ 127.0.0.1 in /etc/hosts)
#
# View installation logs inside containers:
#   podman exec laemp-test-ubuntu cat /home/testuser/laemp-install.log
#   podman exec laemp-test-debian cat /home/testuser/laemp-install.log
#
# Access container shell (even if laemp.sh failed):
#   podman exec -it laemp-test-ubuntu bash
#   podman exec -it laemp-test-debian bash
#
# Clean up:
#   podman-compose down                     # Stop and remove containers
#   podman-compose down -v                  # Also remove volumes
#
# See docs/container-testing.md for comprehensive testing guide

services:
  moodle-test-ubuntu:
    build:
      context: .
      dockerfile: Dockerfile.ubuntu
    image: amp-moodle-ubuntu:24.04
    container_name: laemp-test-ubuntu
    platform: linux/amd64

    # Privileged mode required for systemd
    privileged: true

    # tmpfs mounts for systemd
    tmpfs:
      - /tmp
      - /run
      - /run/lock

    # Volume for systemd and laemp.sh logs
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
      - ./laemp.sh:/usr/local/bin/laemp.sh:ro
      - ubuntu-logs:/home/testuser/logs
      - ubuntu-moodle:/var/www

    # Environment variables
    environment:
      - DEBIAN_FRONTEND=noninteractive
      - TZ=UTC
      - LANG=en_US.UTF-8
      - LC_ALL=en_US.UTF-8

    # Run laemp.sh on startup, then keep container running
    command: >
      /bin/bash -c "
      sudo /usr/local/bin/laemp.sh -c -p 8.4 -w nginx -d mariadb -m 501 -S 2>&1 | tee /home/testuser/laemp-install.log;
      echo 'laemp.sh completed with exit code:' $$?;
      exec sleep infinity
      "

    # Port mappings for web access to Moodle (different from Debian)
    ports:
      - "8090:80"    # HTTP
      - "9443:443"   # HTTPS

    # Health check - verifies container is functional and laemp.sh is accessible
    # Compatible with cloud environments (ECS, Fargate, etc.)
    healthcheck:
      test: ["CMD", "test", "-x", "/usr/local/bin/laemp.sh"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Network
    networks:
      - laemp-test-network

  moodle-test-debian:
    build:
      context: .
      dockerfile: Dockerfile.debian
    image: amp-moodle-debian:13
    container_name: laemp-test-debian
    platform: linux/amd64

    # Privileged mode required for systemd
    privileged: true

    # tmpfs mounts for systemd
    tmpfs:
      - /tmp
      - /run
      - /run/lock

    # Volume for systemd and laemp.sh logs
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
      - ./laemp.sh:/usr/local/bin/laemp.sh:ro
      - debian-logs:/home/testuser/logs
      - debian-moodle:/var/www

    # Environment variables
    environment:
      - DEBIAN_FRONTEND=noninteractive
      - TZ=UTC
      - LANG=en_US.UTF-8
      - LC_ALL=en_US.UTF-8

    # Run laemp.sh on startup, then keep container running
    command: >
      /bin/bash -c "
      sudo /usr/local/bin/laemp.sh -c -p 8.4 -w nginx -d mariadb -m 501 -S 2>&1 | tee /home/testuser/laemp-install.log;
      echo 'laemp.sh completed with exit code:' $$?;
      exec sleep infinity
      "

    # Port mappings for web access to Moodle
    ports:
      - "8080:80"    # HTTP
      - "8443:443"   # HTTPS

    # Health check - verifies container is functional and laemp.sh is accessible
    # Compatible with cloud environments (ECS, Fargate, etc.)
    healthcheck:
      test: ["CMD", "test", "-x", "/usr/local/bin/laemp.sh"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Network
    networks:
      - laemp-test-network

# Named volumes for persistent data across container restarts
volumes:
  ubuntu-logs:
    name: laemp-ubuntu-logs
  ubuntu-moodle:
    name: laemp-ubuntu-moodle
  debian-logs:
    name: laemp-debian-logs
  debian-moodle:
    name: laemp-debian-moodle

# Isolated network for test containers
networks:
  laemp-test-network:
    name: laemp-test-net
    driver: bridge
